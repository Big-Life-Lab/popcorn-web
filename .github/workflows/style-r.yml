name: Style R code

on:
  workflow_dispatch:  # Manually triggered only

permissions:
  contents: write
  pull-requests: write

jobs:
  style:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.4.3"

      - name: Install styler
        run: R -e 'install.packages("styler")'

      - name: Style R code
        run: |
          R -e '
          library(styler)

          # Style all R and qmd files (excluding renv)
          files <- c(
            list.files(pattern = "\\.R$", recursive = TRUE, full.names = TRUE),
            list.files(pattern = "\\.qmd$", recursive = TRUE, full.names = TRUE)
          )

          files <- files[!grepl("^renv/", files)]

          for (file in files) {
            cat("Styling:", file, "\n")
            style_file(file, transformers = tidyverse_style(indent_by = 2))
          }
          '

      - name: Commit styled files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git diff-index --quiet HEAD || git commit -m "style: Auto-format R code with styler"
          git push
